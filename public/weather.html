<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const city = urlParams.get('city');

    if (city) {
      try {
        // Fetch current weather data
        const weatherResponse = await fetch(`/api/weather?city=${city}`);
        const weatherData = await weatherResponse.json();

        // Update weather information on the page
        const weatherDataDiv = document.getElementById('weather-data');
        const rainChance = weatherData.rain ? `${weatherData.rain['1h'] || 0}%` : 'No rain expected';
        const simpleDescription = weatherData.weather[0].main; // Use simpler terms

        weatherDataDiv.innerHTML = `
          <p>City: ${weatherData.name}</p>
          <p>Temperature: ${(weatherData.main.temp - 273.15).toFixed(2)} °C</p>
          <p>Weather: ${simpleDescription}</p>
          <p>Humidity: ${weatherData.main.humidity} %</p>
          <p>Wind Speed: ${weatherData.wind.speed} m/s</p>
          <p>Rain Chance: ${rainChance}</p>
          <p>Visibility: ${(weatherData.visibility / 1000).toFixed(1)} km</p>
          <p>Sunrise: ${new Date(weatherData.sys.sunrise * 1000).toLocaleTimeString()}</p>
          <p>Sunset: ${new Date(weatherData.sys.sunset * 1000).toLocaleTimeString()}</p>
        `;

        // Fetch forecast data for chart
        const forecastResponse = await fetch(`/api/weather/forecast?city=${city}`);
        const forecastData = await forecastResponse.json();

        // Prepare chart data
        const labels = forecastData.list.map(entry =>
          new Date(entry.dt * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        );
        const temps = forecastData.list.map(entry => (entry.main.temp - 273.15).toFixed(1));

        // Render temperature chart
        new Chart(document.getElementById('temperatureChart'), {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'Temperature (°C)',
                data: temps,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                fill: true,
              },
            ],
          },
        });
      } catch (error) {
        console.error('Error fetching weather data:', error);
      }
    }
  });
</script>
